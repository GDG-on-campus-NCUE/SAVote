# 功能規格：SAML SSO 驗證與 Nullifier Secret 管理

**功能分支**: `001-saml-sso-auth`
**建立日期**: 2025-11-30
**狀態**: 草稿
**輸入**: 使用者描述：「實作 SAML SSO 驗證與用於匿名投票的 Nullifier Secret 產生機制」

## 使用者情境與測試 *(必填)*

### 使用者故事 1 - 首次使用者登入與 Nullifier Secret 設定 (優先級: P1)

學生首次造訪投票系統。系統透過學校的 SAML 身分提供者 (IdP) 驗證其身分，接著產生加密的 Nullifier Secret，以確保投票匿名並防止重複投票。使用者必須安全地將此 Secret 儲存在本地。

**為何此優先級**: 這是所有使用者的基礎入口。沒有驗證與 Nullifier Secret 產生，就無法進行投票。它建立了核心的隱私保護機制。

**獨立測試**: 可透過建立新使用者帳號，經由 SAML SSO 登入，並驗證瀏覽器 LocalStorage 中是否產生並儲存了唯一的 Nullifier Secret 來完整測試。測試結果應為一個具有有效 Nullifier Secret 的已驗證工作階段。

**驗收場景**:

1. **假設** 學生在登陸頁面點擊「登入」，**當** 他們被導向學校 IdP 並成功驗證，**則** 他們帶著有效的 JWT token 返回投票系統。
2. **假設** 一個成功驗證的首次使用者，**當** 系統偵測到 LocalStorage 中沒有既有的 Nullifier Secret，**則** 系統會以加密方式產生唯一的 Nullifier Secret，並顯示給使用者，附帶明確的儲存指示。
3. **假設** Nullifier Secret 已顯示，**當** 使用者確認警告訊息（勾選核取方塊），**則** Secret 會被儲存於瀏覽器 LocalStorage，並顯示 Cookie 同意橫幅。
4. **假設** Nullifier Secret 已儲存，**當** 使用者提供選填的 Email 地址，**則** 該 Email 會與其工作階段關聯，用於復原目的。

---

### 使用者故事 2 - 回訪使用者登入與 Secret 驗證 (優先級: P1)

回訪學生再次登入。系統檢查其 LocalStorage 是否存在 Nullifier Secret。若存在，直接進入儀表板。若遺失（例如清除 Cookie），則提示手動重新輸入 Secret。

**為何此優先級**: 對於使用者留存與系統易用性至關重要。使用者必須能無摩擦地返回系統，同時維持 Nullifier Secret 的安全性。

**獨立測試**: 可透過使用已在 LocalStorage 擁有 Nullifier Secret 的現有帳號登入，接著清除 LocalStorage 並再次嘗試登入以驗證復原流程來測試。

**驗收場景**:

1. **假設** 一個在 LocalStorage 擁有有效 Nullifier Secret 的回訪使用者，**當** 他們完成 SAML 驗證，**則** 他們會直接被導向儀表板，無需額外提示。
2. **假設** 一個在 LocalStorage 沒有 Nullifier Secret 的回訪使用者，**當** 他們完成 SAML 驗證，**則** 他們會看到復原提示，要求手動輸入 Secret。
3. **假設** 使用者手動輸入 Nullifier Secret，**當** Secret 通過驗證（透過雜湊比對），**則** 他們進入儀表板。
4. **假設** 使用者輸入無效的 Nullifier Secret，**當** 驗證失敗，**則** 他們會看到錯誤訊息，說明 Secret 不正確且在解決前無法投票。

---

### 使用者故事 3 - 管理員發起的使用者驗證 (優先級: P2)

管理員匯入合格選民名單（學號、班級）並產生 Merkle Tree root 以進行資格驗證。這確保只有獲授權的學生能參與選舉。

**為何此優先級**: 在任何選舉開始前必須完成，但可獨立於使用者登入流程進行。這是選舉設定的先決條件，但不阻擋驗證本身。

**獨立測試**: 可透過上傳包含合格選民的 CSV 檔案，產生 Merkle Tree root，並驗證 root 是否正確儲存且可用於資格證明來測試。

**驗收場景**:

1. **假設** 管理員上傳包含學號與班級的 CSV，**當** 系統處理該檔案，**則** 會建構一個包含所有合格選民作為葉節點的 Merkle Tree。
2. **假設** Merkle Tree 已產生，**當** 系統計算 Merkle Root，**則** root hash 會被儲存並與特定選舉關聯。
3. **假設** 使用者登入並嘗試投票，**當** 系統驗證其資格，**則** 會透過零知識證明檢查其學號是否存在於 Merkle Tree 中。

---

### 邊界案例

- 當使用者的 SAML 斷言在工作階段中過期時會發生什麼？（工作階段逾時處理）
- 系統如何處理遺失 Nullifier Secret 且需要再次投票的使用者？（透過管理員介入進行身分驗證的復原機制）
- 如果使用者嘗試從不同瀏覽器產生多個 Nullifier Secret 會如何？（系統必須警告每個學號只有一個 Secret 有效）
- 系統如何處理驗證期間的 SAML 回調失敗或網路錯誤？
- 如果使用者拒絕提供 Email 地址進行復原會如何？（系統允許投票但警告無法復原 Secret）

## 需求 *(必填)*

### 功能需求

- **FR-001**: 系統必須整合學校的 SAML 2.0 身分提供者進行驗證。
- **FR-002**: 系統必須僅從 SAML 斷言中提取必要的屬性（學號、班級、在學狀態），避免儲存不必要的個人資訊。
- **FR-003**: 系統必須為每個驗證成功的首次使用者產生加密安全的 Nullifier Secret（256 位元隨機值）。
- **FR-004**: 系統必須向使用者顯示一次 Nullifier Secret，並附帶明確警告若遺失將無法復原。
- **FR-005**: 系統必須將 Nullifier Secret 僅儲存於瀏覽器 LocalStorage（絕不存於後端資料庫）。
- **FR-006**: 系統必須提供機制讓使用者在 LocalStorage 被清除時手動重新輸入 Nullifier Secret。
- **FR-007**: 系統必須允許使用者選填 Email 地址，以便在投票後接收證明收據。
- **FR-008**: 系統必須在 SAML 驗證成功後發放包含使用者 ID（雜湊）與工作階段過期時間的 JWT token。
- **FR-009**: 系統必須支援工作階段重新整理 (Refresh)，以防止使用者在活躍投票期間被登出。
- **FR-010**: 系統必須在接受投票前驗證 Nullifier Secret 未曾在同一場選舉中使用過（防止重複投票）。
- **FR-011**: 管理員使用者必須能透過 CSV 匯入合格選民名單（學號、班級）以產生 Merkle Tree。
- **FR-012**: 系統必須從合格選民名單產生 Merkle Tree root hash，用於零知識資格驗證。

### 關鍵實體

- **User (使用者)**: 代表擁有 SAML 屬性（學號雜湊、班級、在學狀態）的學生。擁有關聯的 Nullifier Secret（僅存於客戶端）與選填 Email。
- **Session (工作階段)**: 代表已驗證的使用者工作階段，包含 JWT token、發放時間、過期時間與重新整理能力。
- **Nullifier Secret**: 每個使用者產生的 256 位元加密值，僅存於瀏覽器 LocalStorage，用於產生投票 Nullifier。
- **Eligible Voter Record (合格選民記錄)**: Merkle Tree 的一部分，包含學號與班級，用於產生資格證明而不洩露身分。

## 成功標準 *(必填)*

### 可測量結果

- **SC-001**: 使用者能在 60 秒內完成首次登入與 Nullifier Secret 產生。
- **SC-002**: 95% 的回訪使用者能登入並進入儀表板，無需手動重新輸入 Nullifier Secret。
- **SC-003**: 系統成功與學校 SAML IdP 驗證的成功率達 99.9%（排除網路故障）。
- **SC-004**: 後端資料庫中儲存的 Nullifier Secret 數量為零（透過資料庫稽核驗證）。
- **SC-005**: 管理員能在 2 分鐘內匯入並驗證 1000+ 合格選民。
- **SC-006**: Nullifier Secret 復原率（使用者在提示時成功重新輸入 Secret）超過 90%。
